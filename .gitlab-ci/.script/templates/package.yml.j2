stages:
- build
{% if not package.config.tool and not FOR_TOOL -%}
- test
{% endif -%}
- deploy
{#  #}
{%- set suffix = '.tool' if FOR_TOOL else ''  -%}
{%- set MSVC = package.c_matrix('^vs20\d\d\w*$', tool=FOR_TOOL)  -%}
{%- set GCC = package.c_matrix('^gcc\d+(\-x86)?\w?$', tool=FOR_TOOL)  -%}
{%- set GCC_ARMv8 = package.c_matrix( '^gcc\d+\-armv8\w*$', tool=FOR_TOOL)  -%}
{%- set GCC_ARMv7 = package.c_matrix( '^gcc\d+\-armv7\w*$', tool=FOR_TOOL)  -%}
{%- set GCC_HiSi = package.c_matrix( '^hisiv|himix', tool=FOR_TOOL)  -%}
{# #}
    # ---------------------------------
    #     Build
    # ---------------------------------
{%- if MSVC  %}
{{ package.name }}{{ suffix }}.build@windows:
    stage: build
    tags:
    - builder
    - Windows
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - echo epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for profiles, schemes in MSVC %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  %}


{%- if GCC + GCC_ARMv8  %}
{{ package.name }}{{ suffix }}.build@linux:
    stage: build
    tags:
    - builder
    - Linux
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - echo epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for m in [GCC, GCC_ARMv8] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  -%}

{% if not package.config.tool and not FOR_TOOL -%}
    # ---------------------------------
    # Test
    # ---------------------------------
{% if MSVC  %}
{{ package.name }}{{ suffix }}.test@windows:
    stage: test
    tags:
    - runner
    - Windows
    - '@oss-{{ synthesis.version }}'
    script:
    - cd {{package.name}}
    - echo epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME exec test_package
    parallel:
      matrix:
{%- for m in [MSVC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  -%}

{% if GCC  %}
{{ package.name }}{{ suffix }}.test@linux:
    stage: test
    tags:
    - runner
    - Linux
    - '@oss-{{ synthesis.version }}'
    script:
    - cd {{package.name}}
    - echo epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME exec test_package
    parallel:
      matrix:
{%- for m in [GCC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  %}

{% endif %}    


    # ---------------------------------
    #     deploy
    # ---------------------------------
{{ package.name }}{{ suffix }}.publish@linux:
    stage: deploy
    tags:
    - '@oss-{{ synthesis.version }}'    
    - deployer
    script:
    - cd {{package.name}}
    - echo epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME upload
    parallel:
      matrix:
{%- for m in [MSVC, GCC, GCC_ARMv8] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
