stages:
- build
- test
- deploy
{#  #}
{%- set MSVC = package.c_matrix('^vs20\d\d\w*$')  -%}
{%- set GCC = package.c_matrix('^gcc\d+(\-x86)?\w?$' )  -%}
{%- set GCC_ARMv8 = package.c_matrix( '^gcc\d+\-armv8\w*$' )  -%}
{%- set GCC_ARMv7 = package.c_matrix( '^gcc\d+\-armv7\w*$' )  -%}
{%- set GCC_HiSi = package.c_matrix( '^hisiv|himix' )  -%}
{# #}
    # ---------------------------------
    #     Build
    # ---------------------------------
{%- if MSVC  %}
{{ package.name }}.build@windows:
    stage: build
    tags:
    - builder
    - Windows
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for profiles, schemes in MSVC %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  %}


{%- if GCC + GCC_ARMv8  %}
{{ package.name }}.build@linux:
    stage: build
    tags:
    - builder
    - Linux
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for m in [GCC, GCC_ARMv8] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  -%}

{% if not package.config.tool and not FOR_TOOL %}
{% set programs = package.config.program.get('Windows') or [] %}
    # ---------------------------------
    # Test
    # ---------------------------------

{% if MSVC  and programs %}
{{ package.name }}.test@windows:
    stage: test
    tags:
    - runner
    - Windows
    - '@oss-{{ synthesis.version }}'
    script:
    - cd {{package.name}}
    {% for p in programs %}
    - epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME exec {{p}}
    {% endfor %}
    parallel:
      matrix:
{%- for m in [MSVC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  -%}

{% set programs = package.config.program.get('Linux') or [] %}
{% if GCC and programs %}
{{ package.name }}.test@linux:
    stage: test
    tags:
    - runner
    - Linux
    - '@oss-{{ synthesis.version }}'
    script:
    - cd {{package.name}}
    {% for p in programs %}
    - epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME exec {{p}}
    {% endfor %}
    parallel:
      matrix:
{%- for m in [GCC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  %}

{% endif %}    


    # ---------------------------------
    #     deploy
    # ---------------------------------
{{ package.name }}.publish@linux:
    stage: deploy
    tags:
    - '@oss-{{ synthesis.version }}'    
    - deployer
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME upload
    parallel:
      matrix:
{%- for m in [MSVC, GCC, GCC_ARMv8] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
