stages:
- build
- deploy
{#  #}
{%- set suffix = '.tool' if FOR_TOOL else ''  -%}
{%- set MSVC = package.c_matrix('^vs20\d\d\w*$', tool=FOR_TOOL)  -%}
{%- set GCC = package.c_matrix('^gcc\d+(\-x86)?\w?$', tool=FOR_TOOL)  -%}
{# #}
    # ---------------------------------
    #     Build
    # ---------------------------------
{%- if MSVC  %}
{{ package.name }}{{ suffix }}.build@windows:
    stage: build
    tags:
    - builder
    - Windows
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for profiles, schemes in MSVC %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  %}


{%- if GCC %}
{{ package.name }}{{ suffix }}.build@linux:
    stage: build
    tags:
    - builder
    - Linux
    - '@oss-{{ synthesis.version }}'
    artifacts:
      paths:
      - {{package.name}}/.conan/$PROFILE/$SCHEME
      - {{package.name}}/.epm
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  create --archive .conan/$PROFILE/$SCHEME
    parallel:
      matrix:
{%- for m in [GCC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
{%- endif  -%}
{##}
    # ---------------------------------
    #     deploy
    # ---------------------------------
{{ package.name }}{{ suffix }}.publish@linux:
    stage: deploy
    tags:
    - '@oss-{{ synthesis.version }}'    
    - deployer
    script:
    - cd {{package.name}}
    - epm --profile $PROFILE --scheme $SCHEME  --storage .conan/$PROFILE/$SCHEME upload
    parallel:
      matrix:
{%- for m in [MSVC, GCC] -%}
{%- if m  -%}
{%- for profiles, schemes in m %}
      - SCHEME: {{ schemes | list }}
        PROFILE: {{ profiles | list }}
{% endfor -%}
{%- endif  -%}
{%- endfor  -%}
