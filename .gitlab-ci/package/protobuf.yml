stages:
- build
- test
- deploy

    # =================================
    # MSVC build
    # =================================
protobuf:MSVC@build:
  stage: build
  tags:
  - Windows
  - builder
  - workbench:oss-0.2
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['vs2019d', 'vs2019']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc6-armv8 armv8 build
    # =========================================
protobuf:gcc6-armv8@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc6-armv8
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc6-armv8', 'gcc6-armv8d']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc6 x86_64 build
    # =========================================
protobuf:gcc6@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc6
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc6', 'gcc6d']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc7-armv7 armv7 build
    # =========================================
protobuf:gcc7-armv7@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc7-armv7
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc7-armv7', 'gcc7-armv7d']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc5 x86_64 build
    # =========================================
protobuf:gcc5@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc5
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5', 'gcc5d']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc7 x86_64 build
    # =========================================
protobuf:gcc7@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc7
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc7d', 'gcc7']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc5-armv8 armv8 build
    # =========================================
protobuf:gcc5-armv8@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc5-armv8
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5-armv8d', 'gcc5-armv8']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc5-armv7 armv7 build
    # =========================================
protobuf:gcc5-armv7@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc5-armv7
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5-armv7']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc6-armv7 armv7 build
    # =========================================
protobuf:gcc6-armv7@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc6-armv7
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc6-armv7', 'gcc6-armv7d']
      EPM_SCHEME: ['shared', 'static']

    # =========================================
    # gcc7-armv8 armv8 build
    # =========================================
protobuf:gcc7-armv8@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:oss-0.2
  image: 172.16.0.119:8482/edgetoolkit/gcc7-armv8
  artifacts:
    paths:
    - protobuf/.conan/$EPM_PROFILE/$EPM_SCHEME
    - protobuf/.epm
  script:
  - cd protobuf
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc7-armv8d', 'gcc7-armv8']
      EPM_SCHEME: ['shared', 'static']

    # =================================
    # MSVC test
    # =================================
protobuf:MSVC@test:
  stage: test
  tags:
  - Windows
  - runner
  - workbench:oss-0.2
  dependencies:
  - protobuf:MSVC@build
  script: |
    cd protobuf
    $EPM_SANDBOX_STORAGE = ".conan/$EPM_PROFILE/$EPM_SCHEME" 
    
  parallel:
    matrix:
    - EPM_PROFILE: ['vs2019d', 'vs2019']
      EPM_SCHEME: ['shared', 'static']




    # =========================================
    # gcc6 x86_64 test
    # =========================================
protobuf:gcc6@test:
  stage: test
  tags:
  - Linux
  - runner
  - docker
  - workbench:oss-0.2
  image: edgetoolkit/ubuntu:xenial
  dependencies:
  - protobuf:gcc6@build
  script:
    cd protobuf
    export EPM_SANDBOX_STORAGE = ".conan/$EPM_PROFILE/$EPM_SCHEME"    
    
    
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc6', 'gcc6d']
      EPM_SCHEME: ['shared', 'static']




    # =========================================
    # gcc5 x86_64 test
    # =========================================
protobuf:gcc5@test:
  stage: test
  tags:
  - Linux
  - runner
  - docker
  - workbench:oss-0.2
  image: edgetoolkit/ubuntu:xenial
  dependencies:
  - protobuf:gcc5@build
  script:
    cd protobuf
    export EPM_SANDBOX_STORAGE = ".conan/$EPM_PROFILE/$EPM_SCHEME"    
    
    
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5', 'gcc5d']
      EPM_SCHEME: ['shared', 'static']


    # =========================================
    # gcc7 x86_64 test
    # =========================================
protobuf:gcc7@test:
  stage: test
  tags:
  - Linux
  - runner
  - docker
  - workbench:oss-0.2
  image: edgetoolkit/ubuntu:xenial
  dependencies:
  - protobuf:gcc7@build
  script:
    cd protobuf
    export EPM_SANDBOX_STORAGE = ".conan/$EPM_PROFILE/$EPM_SCHEME"    
    
    
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc7d', 'gcc7']
      EPM_SCHEME: ['shared', 'static']









    # =================================
    # Deploy to conan repo
    # =================================
protobuf@deploy:
  stage: deploy
  tags:
  - conan
  - deployer
  - workbench:oss-0.2
  dependencies:
  - protobuf:gcc6-armv8@build
  - protobuf:gcc6@build
  - protobuf:MSVC@build
  - protobuf:gcc7-armv7@build
  - protobuf:gcc5@build
  - protobuf:gcc7@build
  - protobuf:gcc5-armv8@build
  - protobuf:gcc5-armv7@build
  - protobuf:gcc6-armv7@build
  - protobuf:gcc7-armv8@build
  script: |
    set -e
    cd protobuf
    PROFILES=(
      gcc6-armv8 gcc6-armv8d
      gcc6 gcc6d
      vs2019d vs2019
      gcc7-armv7 gcc7-armv7d
      gcc5 gcc5d
      gcc7d gcc7
      gcc5-armv8d gcc5-armv8
      gcc5-armv7
      gcc6-armv7 gcc6-armv7d
      gcc7-armv8d gcc7-armv8
    )

    for profile in ${PROFILES[*]}
    do
      for scheme in shared static
      do
        export EPM_PROFILE=$profile
        export EPM_FPROFILE=$scheme
        echo [protobuf] - Upload...  $profile $shcme
        epm upload --storage .conan/$profile/$scheme
      done
    done 