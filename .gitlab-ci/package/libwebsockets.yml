stages:
- build
- test
- deploy

    # =================================
    # MSVC build
    # =================================
libwebsockets:MSVC@build:
  stage: build
  tags:
  - Windows
  - builder
  - workbench:Z1
  artifacts:
    paths:
    - libwebsockets/.conan/$EPM_PROFILE/$EPM_SCHEME
    - libwebsockets/.epm
  script:
  - cd libwebsockets
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME  --with-deps --clear
  parallel:
    matrix:
    - EPM_PROFILE: ['vs2019d', 'vs2019']
      EPM_SCHEME: ['static', 'shared']

    # =========================================
    # gcc5 x86_64 build
    # =========================================
libwebsockets:gcc5@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:Z1
  image: 172.16.0.119:8482/edgetoolkit/gcc5
  artifacts:
    paths:
    - libwebsockets/.conan/$EPM_PROFILE/$EPM_SCHEME
    - libwebsockets/.epm
  script:
  - cd libwebsockets
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME --with-deps --clear
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5d', 'gcc5']
      EPM_SCHEME: ['static', 'shared']

    # =========================================
    # gcc5-armv7 armv7 build
    # =========================================
libwebsockets:gcc5-armv7@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:Z1
  image: 172.16.0.119:8482/edgetoolkit/gcc5-armv7
  artifacts:
    paths:
    - libwebsockets/.conan/$EPM_PROFILE/$EPM_SCHEME
    - libwebsockets/.epm
  script:
  - cd libwebsockets
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME --with-deps --clear
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5-armv7', 'gcc5-armv7d']
      EPM_SCHEME: ['static', 'shared']

    # =========================================
    # gcc5-armv8 armv8 build
    # =========================================
libwebsockets:gcc5-armv8@build:
  stage: build
  tags:
  - Linux
  - builder
  - docker
  - workbench:Z1
  image: 172.16.0.119:8482/edgetoolkit/gcc5-armv8
  artifacts:
    paths:
    - libwebsockets/.conan/$EPM_PROFILE/$EPM_SCHEME
    - libwebsockets/.epm
  script:
  - cd libwebsockets
  - epm create --archive .conan/$EPM_PROFILE/$EPM_SCHEME --with-deps --clear
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5-armv8', 'gcc5-armv8d']
      EPM_SCHEME: ['static', 'shared']

    # =================================
    # MSVC test
    # =================================
libwebsockets:MSVC@test:
  stage: test
  tags:
  - Windows
  - runner
  - workbench:Z1
  dependencies:
  - libwebsockets:MSVC@build
  script:
  - cd libwebsockets
  - $env:EPM_SANDBOX_STORAGE=".conan/$EPM_PROFILE/$EPM_SCHEME" 
        
  - . .epm/$EPM_PROFILE@$EPM_SCHEME/sandbox/test_package
    
  parallel:
    matrix:
    - EPM_PROFILE: ['vs2019d', 'vs2019']
      EPM_SCHEME: ['static', 'shared']


    # =========================================
    # gcc5 x86_64 test
    # =========================================
libwebsockets:gcc5@test:
  stage: test
  tags:
  - Linux
  - runner
  - docker
  - workbench:Z1
  image: ubuntu:xenial
  dependencies:
  - libwebsockets:gcc5@build
  script:
  - cd libwebsockets
  - export EPM_SANDBOX_STORAGE=".conan/$EPM_PROFILE/$EPM_SCHEME"    
        
  - .epm/$EPM_PROFILE@$EPM_SCHEME/sandbox/test_package
    
  parallel:
    matrix:
    - EPM_PROFILE: ['gcc5d', 'gcc5']
      EPM_SCHEME: ['static', 'shared']





    # =================================
    # Deploy to conan repo
    # =================================
libwebsockets@deploy:
  stage: deploy
  tags:
  - conan
  - deployer
  - workbench:Z1

  image: 172.16.0.119:8482/edgetoolkit/gcc5

  dependencies:
  - libwebsockets:MSVC@build
  - libwebsockets:gcc5@build
  - libwebsockets:gcc5-armv7@build
  - libwebsockets:gcc5-armv8@build
  script:
  - cd libwebsockets
  - epm -p vs2019d -s static upload --storage .conan/vs2019d/static
  - epm -p vs2019d -s shared upload --storage .conan/vs2019d/shared
  - epm -p vs2019 -s static upload --storage .conan/vs2019/static
  - epm -p vs2019 -s shared upload --storage .conan/vs2019/shared
  - epm -p gcc5d -s static upload --storage .conan/gcc5d/static
  - epm -p gcc5d -s shared upload --storage .conan/gcc5d/shared
  - epm -p gcc5 -s static upload --storage .conan/gcc5/static
  - epm -p gcc5 -s shared upload --storage .conan/gcc5/shared
  - epm -p gcc5-armv7 -s static upload --storage .conan/gcc5-armv7/static
  - epm -p gcc5-armv7 -s shared upload --storage .conan/gcc5-armv7/shared
  - epm -p gcc5-armv7d -s static upload --storage .conan/gcc5-armv7d/static
  - epm -p gcc5-armv7d -s shared upload --storage .conan/gcc5-armv7d/shared
  - epm -p gcc5-armv8 -s static upload --storage .conan/gcc5-armv8/static
  - epm -p gcc5-armv8 -s shared upload --storage .conan/gcc5-armv8/shared
  - epm -p gcc5-armv8d -s static upload --storage .conan/gcc5-armv8d/static
  - epm -p gcc5-armv8d -s shared upload --storage .conan/gcc5-armv8d/shared